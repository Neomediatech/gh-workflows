name: Check and Build Docker Images (by Copilot)

on:
  workflow_call:
    inputs:
      base-image:
        description: 'Base image to check'
        required: true
        type: string
      derived-image-prefix:
        description: 'Prefix for the derived image (e.g. ghcr.io/org/repo)'
        required: true
        type: string
      versions:
        description: 'JSON array of versions/tags to check'
        required: true
        type: string
      derived-image-repo:
        description: 'Github repo name (e.g. Neomediatech/rspamd)'
        required: false
        type: string
      derived-image-repo-ref:
        description: 'Github repo ref (e.g. "main" or "master")'
        required: false
        type: string
        default: "main"
      update-image:
        description: 'Whether to update the image or not (e.g. true or false)'
        required: false
        type: string
        default: "false"
      build-test-image:
        description: 'Whether to build a test image or not (e.g. true or false)'
        required: false
        type: string
        default: "false"

permissions:
  contents: read
  packages: write

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: ${{ fromJson(inputs.versions) }}
      max-parallel: 1

    steps:
      # Checkout il repo di questo workflow (utile se hai file di supporto qui)
      - name: Checkout this workflow repository
        uses: actions/checkout@v4

      # Checkout il repository chiamante (serve per la build se il Dockerfile/context sono lì)
      - name: Checkout calling repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.derived-image-repo }}
          ref: ${{ inputs.derived-image-repo-ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
        if: ${{ inputs.derived-image-repo != '' && inputs.derived-image-repo != null }}
    
      # Step di verifica aggiornamento immagine
      - name: Check if derived image needs update
        id: check
        run: |
          BASE_IMAGE="${{ inputs.base-image }}"
          DERIVED_IMAGE="${{ inputs.derived-image-prefix }}:${{ matrix.version }}"

          echo "Controllo digest per $BASE_IMAGE e $DERIVED_IMAGE"

          BASE_DIGEST=$(skopeo inspect docker://$BASE_IMAGE | jq -r '.Digest')
          DERIVED_DIGEST=$(skopeo inspect docker://$DERIVED_IMAGE | jq -r '.Digest' || echo "")

          echo "Base digest: $BASE_DIGEST"
          echo "Derived digest: $DERIVED_DIGEST"

          if [[ -z "$DERIVED_DIGEST" || "$DERIVED_DIGEST" == "null" ]]; then
            echo "Derived image not found or not accessible, needs build."
            echo "needs_build=true" >> $GITHUB_OUTPUT
          elif [[ "$BASE_DIGEST" != "$DERIVED_DIGEST" ]]; then
            echo "Base and derived digests do not match, needs build."
            echo "needs_build=true" >> $GITHUB_OUTPUT
          else
            echo "Image up to date."
            echo "needs_build=false" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      # Build e push SOLO se serve aggiornare
      - name: Build and push Docker image
        id: vars
        if: steps.check.outputs.needs_build == 'true' && inputs.update-image == 'true'
        run: |
          [[ "${{ inputs.build-test-image }}" == "true" ]] && TAG_TEST="-test" || TAG_TEST=""
          echo "Building and pushing ${{ inputs.derived-image-prefix }}:${{ matrix.version }}$TAG_TEST"
          docker build -t ${{ inputs.derived-image-prefix }}:${{ matrix.version }}$TAG_TEST -f Dockerfile.${{ matrix.version }} .
          docker push ${{ inputs.derived-image-prefix }}:${{ matrix.version }}$TAG_TEST
          REPO_NAME=$(echo "${{ inputs.derived-image-prefix }}"|sed 's|ghcr.io/||' | awk -F'/' '{print $2}')
          echo "txt_to_copy=${REPO_NAME}_${{ matrix.version }}_trivy-report.txt" >> $GITHUB_OUTPUT
          
      - name: Run Trivy vulnerability scanner and save TABLE report
        uses: aquasecurity/trivy-action@0.30.0
        with:
          image-ref: ${{ inputs.derived-image-prefix }}:${{ matrix.version }}$TAG_TEST
          format: 'table'
          output: ${{ steps.vars.outputs.txt_to_copy }}
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
        env:
          INPUT_IMAGE_REF: ${{ inputs.derived-image-prefix }}:${{ matrix.version }}$TAG_TEST
        if: steps.check.outputs.needs_build == 'true' && inputs.update-image == 'true'

      - name: Upload txt Trivy report
        id: upload-txt
        uses: actions/upload-artifact@v4
        with:
          name: uploaded-txt_${{ inputs.dockertag }}
          path: ${{ steps.vars.outputs.txt_to_copy }}
          overwrite: true
          compression-level: 0
          retention-days: 1
        if: steps.check.outputs.needs_build == 'true' && inputs.update-image == 'true'

      - name: Push Trivy report to Repo
        uses: Neomediatech/gh-workflows/.github/workflows/copy-file-to-another-repo.yml@main
        with:
          file_id: ${{ steps.upload-txt.outputs.artifact-id }}
          filename: ${{ steps.vars.outputs.txt_to_copy }}
          dockertag: ${{ matrix.version }}
        if: steps.check.outputs.needs_build == 'true' && inputs.update-image == 'true'
      
      # Notifica che l'immagine non viene aggiornata perché sì è impostata la variabile update-image a 'false'
      - name: Skip image update because user chosen to not update it
        if: inputs.update-image != 'true'
        run: |
          echo "NOT updating image because update-image = ${{ inputs.update-image }}"

      # Notifica che l'immagine non viene aggiornata perché l'immagine di base è già aggiornata'
      - name: Skip image update because base image is updated
        if: steps.check.outputs.needs_build != 'true'
        run: |
          echo "NOT updating image because base image is updated (needs_build = ${{ steps.check.outputs.needs_build }})"

      # Docker logout (opzionale, buono per pulizia)
      - name: Docker logout
        run: docker logout ghcr.io
