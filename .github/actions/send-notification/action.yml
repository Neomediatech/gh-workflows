# .github/actions/send-notification/action.yml
name: Notifica (via Apprise o altro) con report e cronologia

inputs:
  status:
    required: false
    type: string
    description: "Risultato dell'operazione: success o failure"
  title:
    required: false
    type: string
    description: "Titolo del report"
    default: "gh notification"
  message:
    required: false
    type: string
    description: "Messaggio personalizzato da includere"
  report_file:
    required: false
    type: string
    default: "last-update-report.txt"
    description: "Nome del file da allegare alla notifica email"
  notify_url:
    required: false
    type: string
    description: "Override per l'URL di notifica Apprise (push)"
  email_url:
    required: false
    type: string
    description: "Override per l'URL email Apprise"
  build-result:
    required: false
    type: string
    description: "Build image result"
  report-name:
    required: false
    type: string
    description: "Report filename"
  image-update-result:
    required: false
    type: string
    description: "Image update result"
  commit:
    required: false
    type: string
    description: "Commit just pushed"
  notify-cmd:
    required: true
    type: string
    description: "Command for notification"
  notify-up:
    required: true
    type: string
  notify-endpoint:
    required: true
    type: string
    description: "Endpoint for notification"
  notify-options:
    required: false
    type: string
    description: "Options for notify command"
    default: " "

outputs:
  image-res:
    description: "Result of the executed command"
    value: ${{ steps.main_logic.outputs.cmd-res }}
  update-needed:
    description: "Whether the derived-image needs updating (true/false/unknown)"
    value: ${{ steps.main_logic.outputs.update-needed }}
  base-img-pkg-ver:
    description: "Package versione taken from base image"
    value: ${{ steps.main_logic.outputs.base-img-pkg-ver }}

runs:
  using: "composite"
  steps:
    - name: Scarica report
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.report-name }}
        path: artifacts
      if: ${{ inputs.report-name }} != ""

    - name: Invia notifica email (con eventuale report allegato)
      shell: bash
      run: |
        #ls -laR artifacts
        BODY_CONTENT="$(< artifacts/*)"
        
        # attach all files
        ATTACHMENTS=""
        i=1
        for file in artifacts/*; do
          if [ -f "$file" ]; then
            ATTACHMENTS+=" -F 'attach$i=@$file'"
            ((i++))
          fi
        done
        
        ${{ inputs.notify-cmd }} --no-progress-meter --user "${{ inputs.notify-up }}" \
             -X POST ${{ inputs.notify-endpoint }} \
             ${{ inputs.notify-options }} \
             $ATTACHMENTS \
             -F "title=${{ inputs.title }}" \
             -F "body=$BODY_CONTENT"
